<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="squire.page">
<title>Booster Model: Difference Model • squire.page</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Booster Model: Difference Model">
<meta property="og:description" content="squire.page">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">squire.page</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/booster_pathway.html">Nimue rewrite: Booster Pathway</a>
    <a class="dropdown-item" href="../articles/difference_model.html">Booster Model: Difference Model</a>
    <a class="dropdown-item" href="../articles/rt_optimise.html">New Fitting Method: Rt Optimisation</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="difference_model_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Booster Model: Difference Model</h1>
            
      
      
      <div class="d-none name"><code>difference_model.Rmd</code></div>
    </div>

    
    
<p>To gain some speed during the fitting process we can convert the complex ODE booster version of nimue into a difference model with a small step size. This is equivalent to using Euler’s method to solve the ODE.</p>
<p>When the model has limited time-varying parameter this method seems to be non-optimal compared to the adaptive step size Dormand-Prince solver we normally use. However, in a set-up with many time-varying parameters, we can explicitly control the step size with a significant increase in speed, at the cost of accuracy.</p>
<p>This vignette will explore the performance and “closeness” of the difference model.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>The difference model is only for use in the fitting procedure, so cannot be accessed normally. Instead, specifying <code>use_difference=TRUE</code> when calling <code>nimue_booster_model</code> will add the difference model to <code>$odin_difference_model</code> where it can be called like <code>$odin_model</code>.</p>
<p>The difference model is written in odin, using the discrete model setup. The model code is automatically generated from the ODE code, simply changing derivatives to updates and scaling time changing parameters and the updates by <span class="math inline">\(\Delta_t\)</span>.</p>
</div>
<div class="section level2">
<h2 id="comparison">Comparison<a class="anchor" aria-label="anchor" href="#comparison"></a>
</h2>
</div>
<div class="section level2">
<h2 id="short-term-changes">Short-term changes<a class="anchor" aria-label="anchor" href="#short-term-changes"></a>
</h2>
<p>In the model fitting we only run the model for short periods of time, i.e. a month to fit one Rt term. We will explore this using data from a previous fit to the UK excess mortality data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">dts</span></span>
<span><span class="co">#load GBR data</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"vignettes"</span>, <span class="st">"GBR.Rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">squire_model</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/nimue_booster_model.html">nimue_booster_model</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#use first fitted sample</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">parameters</span>,</span>
<span>                    <span class="va">fit</span><span class="op">$</span><span class="va">samples</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#get odin parameters</span></span>
<span><span class="va">odin_params</span> <span class="op">&lt;-</span> <span class="fu">squire.page</span><span class="fu">:::</span><span class="fu">get_parameters</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">update_model_pars</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">params</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">set_user</span>, <span class="va">params</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">run_diff_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">t</span>, <span class="va">dt</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">dt_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">new_t</span> <span class="op">&lt;-</span> <span class="va">t</span> <span class="op">*</span> <span class="va">dt_multi</span></span>
<span>  <span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">new_t</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#run up to the first month of </span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">fit</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">t_start</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#perform the ode run</span></span>
<span><span class="fu">update_model_pars</span><span class="op">(</span><span class="va">ode_model</span>, <span class="va">odin_params</span><span class="op">)</span></span>
<span><span class="va">ode_run</span> <span class="op">&lt;-</span> <span class="va">ode_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#difference models</span></span>
<span><span class="va">diff_runs</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">dts</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">odin_params</span><span class="op">$</span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">dt</span></span>
<span>  <span class="fu">update_model_pars</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">odin_params</span><span class="op">)</span></span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dt</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#compare results</span></span>
<span><span class="va">ode_index</span> <span class="op">&lt;-</span> <span class="fu">squire</span><span class="fu">:::</span><span class="fu">odin_index</span><span class="op">(</span><span class="va">ode_model</span><span class="op">)</span></span>
<span><span class="va">diff_index</span> <span class="op">&lt;-</span> <span class="fu">squire</span><span class="fu">:::</span><span class="fu">odin_index</span><span class="op">(</span><span class="va">diff_model</span><span class="op">)</span></span>
<span><span class="va">extract_var</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">output</span>, <span class="va">var</span>, <span class="va">model_index</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">output</span><span class="op">[</span>,<span class="va">model_index</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">var_of_interest</span> <span class="op">&lt;-</span> <span class="st">"E2"</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">diff_runs</span>, <span class="op">~</span><span class="fu">tibble</span><span class="op">(</span></span>
<span>  t <span class="op">=</span> <span class="va">t</span>,</span>
<span>  value <span class="op">=</span> <span class="fu">extract_var</span><span class="op">(</span><span class="va">.x</span>, <span class="va">var_of_interest</span>, <span class="va">diff_index</span><span class="op">)</span></span>
<span><span class="op">)</span>, .id <span class="op">=</span> <span class="st">"dt"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>dt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">value</span>, colour <span class="op">=</span> <span class="va">dt</span>, group <span class="op">=</span> <span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>      t <span class="op">=</span> <span class="va">t</span>,</span>
<span>      ode <span class="op">=</span> <span class="fu">extract_var</span><span class="op">(</span><span class="va">ode_run</span>, <span class="va">var_of_interest</span>, <span class="va">ode_index</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">ode</span>, group <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"black"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="va">var_of_interest</span>, colour <span class="op">=</span> <span class="st">"Dt"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/theme_pubr.html" class="external-link">theme_pubclean</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_colour_viridis_c</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="difference_model_files/figure-html/short%20term%20error-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">squash_axis</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span>, <span class="va">factor</span><span class="op">)</span> <span class="op">{</span> </span>
<span>    <span class="co"># A transformation function that squashes the range of [from, to] by factor on a given axis </span></span>
<span></span>
<span>    <span class="co"># Args:</span></span>
<span>    <span class="co">#   from: left end of the axis</span></span>
<span>    <span class="co">#   to: right end of the axis</span></span>
<span>    <span class="co">#   factor: the compression factor of the range [from, to]</span></span>
<span>    <span class="co">#</span></span>
<span>    <span class="co"># Returns:</span></span>
<span>    <span class="co">#   A transformation called "squash_axis", which is capsulated by trans_new() function</span></span>
<span></span>
<span>  <span class="va">trans</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>    </span>
<span>      <span class="co"># get indices for the relevant regions</span></span>
<span>      <span class="va">isq</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&gt;</span> <span class="va">from</span> <span class="op">&amp;</span> <span class="va">x</span> <span class="op">&lt;</span> <span class="va">to</span></span>
<span>      <span class="va">ito</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&gt;=</span> <span class="va">to</span></span>
<span></span>
<span>      <span class="co"># apply transformation</span></span>
<span>      <span class="va">x</span><span class="op">[</span><span class="va">isq</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">from</span> <span class="op">+</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">isq</span><span class="op">]</span> <span class="op">-</span> <span class="va">from</span><span class="op">)</span><span class="op">/</span><span class="va">factor</span></span>
<span>      <span class="va">x</span><span class="op">[</span><span class="va">ito</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">from</span> <span class="op">+</span> <span class="op">(</span><span class="va">to</span> <span class="op">-</span> <span class="va">from</span><span class="op">)</span><span class="op">/</span><span class="va">factor</span> <span class="op">+</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">ito</span><span class="op">]</span> <span class="op">-</span> <span class="va">to</span><span class="op">)</span></span>
<span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">inv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>      <span class="co"># get indices for the relevant regions</span></span>
<span>      <span class="va">isq</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&gt;</span> <span class="va">from</span> <span class="op">&amp;</span> <span class="va">x</span> <span class="op">&lt;</span> <span class="va">from</span> <span class="op">+</span> <span class="op">(</span><span class="va">to</span> <span class="op">-</span> <span class="va">from</span><span class="op">)</span><span class="op">/</span><span class="va">factor</span></span>
<span>      <span class="va">ito</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">&gt;=</span> <span class="va">from</span> <span class="op">+</span> <span class="op">(</span><span class="va">to</span> <span class="op">-</span> <span class="va">from</span><span class="op">)</span><span class="op">/</span><span class="va">factor</span></span>
<span></span>
<span>      <span class="co"># apply transformation</span></span>
<span>      <span class="va">x</span><span class="op">[</span><span class="va">isq</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">from</span> <span class="op">+</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">isq</span><span class="op">]</span> <span class="op">-</span> <span class="va">from</span><span class="op">)</span> <span class="op">*</span> <span class="va">factor</span></span>
<span>      <span class="va">x</span><span class="op">[</span><span class="va">ito</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">to</span> <span class="op">+</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">ito</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="va">from</span> <span class="op">+</span> <span class="op">(</span><span class="va">to</span> <span class="op">-</span> <span class="va">from</span><span class="op">)</span><span class="op">/</span><span class="va">factor</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># return the transformation</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/trans_new.html" class="external-link">trans_new</a></span><span class="op">(</span><span class="st">"squash_axis"</span>, <span class="va">trans</span>, <span class="va">inv</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plot_perf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">perf</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">max_time</span> <span class="op">&lt;-</span> <span class="va">perf</span><span class="op">$</span><span class="va">time</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">min_max_time</span> <span class="op">&lt;-</span> <span class="va">perf</span><span class="op">$</span><span class="va">time</span><span class="op">[[</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">dts</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">max_time_2</span> <span class="op">&lt;-</span> <span class="va">perf</span><span class="op">$</span><span class="va">time</span><span class="op">[[</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">dts</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">dts</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">trunc_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">max_time_2</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span></span>
<span>  <span class="va">trunc_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">min_max_time</span><span class="op">)</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">perf</span><span class="op">)</span><span class="op">)</span>, <span class="op">~</span><span class="fu">tibble</span><span class="op">(</span></span>
<span>    dt <span class="op">=</span> <span class="va">perf</span><span class="op">$</span><span class="va">dt</span><span class="op">[</span><span class="va">.x</span><span class="op">]</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">perf</span><span class="op">$</span><span class="va">time</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">time</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_boxplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">max_time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">scale_y_continuous</span><span class="op">(</span>trans <span class="op">=</span> <span class="fu">squash_axis</span><span class="op">(</span><span class="va">trunc_start</span>, <span class="va">trunc_end</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">trunc_start</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">trunc_start</span>, <span class="va">trunc_end</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">trunc_end</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">max_time</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/theme_pubr.html" class="external-link">theme_pubclean</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Dt"</span>, y <span class="op">=</span> <span class="st">"Run Time"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">perf</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  <span class="va">ode_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span>, iterations <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="op">)</span></span>
<span><span class="va">perf</span><span class="op">$</span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dts</span><span class="op">)</span></span>
<span><span class="fu">plot_perf</span><span class="op">(</span><span class="va">perf</span><span class="op">)</span></span></code></pre></div>
<p><img src="difference_model_files/figure-html/perfomance-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Comparing the two plots we see that <span class="math inline">\(\Delta_t = 0.01\)</span> gives the best match with <span class="math inline">\(\Delta_t = 0.1\)</span> close enough to be useful. However we find that in terms of performance, <span class="math inline">\(\Delta_t = 0.1\)</span> takes a similar amount of time to the ODE model with only <span class="math inline">\(\Delta_t = 1\)</span> having significant performance gains. <span class="math inline">\(\Delta_t = 0.25\)</span> represents a good sweet spot between performance and error.</p>
<p>This period of simulation may not be representative, so we will also look at a period where there are more time-varying parameters i.e. vaccinations are occurring.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_t</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tt_R0</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tt_R0</span> <span class="op">+</span> <span class="va">fit</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">start_date</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-01-01"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span><span class="co">#generate ODE simulation up to this time</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="va">ode_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">sim_t</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span></span>
<span><span class="co">#setup the initial conditions</span></span>
<span><span class="va">update_conditions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">output</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">var</span> <span class="kw">in</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html" class="external-link">str_subset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span>, <span class="st">"_0"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">out_var</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">"_0"</span><span class="op">)</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">age</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">17</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">params</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">age</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">output</span><span class="op">[</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_var</span>, <span class="st">"\\["</span>, <span class="va">age</span>, <span class="st">","</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">params</span></span>
<span><span class="op">}</span></span>
<span><span class="va">initial_conds</span> <span class="op">&lt;-</span> <span class="fu">update_conditions</span><span class="op">(</span><span class="va">odin_params</span>, <span class="va">output</span><span class="op">)</span></span>
<span><span class="co">#ode run</span></span>
<span><span class="va">sim_period</span> <span class="op">&lt;-</span> <span class="va">sim_t</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">14</span><span class="op">*</span><span class="fl">2</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">update_model_pars</span><span class="op">(</span><span class="va">ode_model</span>, <span class="va">initial_conds</span><span class="op">)</span></span>
<span><span class="va">ode_run</span> <span class="op">&lt;-</span> <span class="va">ode_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">sim_period</span><span class="op">)</span></span>
<span><span class="co">#difference runs </span></span>
<span><span class="va">diff_runs</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">dts</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">initial_conds</span><span class="op">$</span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">dt</span></span>
<span>  <span class="fu">update_model_pars</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">initial_conds</span><span class="op">)</span></span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">sim_period</span>, <span class="va">dt</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">diff_runs</span>, <span class="op">~</span><span class="fu">tibble</span><span class="op">(</span></span>
<span>  t <span class="op">=</span> <span class="va">sim_period</span>,</span>
<span>  value <span class="op">=</span> <span class="fu">extract_var</span><span class="op">(</span><span class="va">.x</span>, <span class="va">var_of_interest</span>, <span class="va">diff_index</span><span class="op">)</span></span>
<span><span class="op">)</span>, .id <span class="op">=</span> <span class="st">"dt"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>dt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">value</span>, colour <span class="op">=</span> <span class="va">dt</span>, group <span class="op">=</span> <span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>      t <span class="op">=</span> <span class="va">sim_period</span>,</span>
<span>      ode <span class="op">=</span> <span class="fu">extract_var</span><span class="op">(</span><span class="va">ode_run</span>, <span class="va">var_of_interest</span>, <span class="va">ode_index</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">ode</span>, group <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"black"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="va">var_of_interest</span>, colour <span class="op">=</span> <span class="st">"Dt"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/theme_pubr.html" class="external-link">theme_pubclean</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_colour_viridis_c</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="difference_model_files/figure-html/vaccination%20period-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">perf</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  <span class="va">ode_model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu">run_diff_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">t</span>, <span class="va">dts</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span>, iterations <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="op">)</span></span>
<span><span class="va">perf</span><span class="op">$</span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dts</span><span class="op">)</span></span>
<span><span class="fu">plot_perf</span><span class="op">(</span><span class="va">perf</span><span class="op">)</span></span></code></pre></div>
<p><img src="difference_model_files/figure-html/vaccination%20performance-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Compared to the previous simulation, little has changed in terms of performance, however the error from the difference model is greatly reduced, with <span class="math inline">\(\Delta_t = 1\)</span> no longer so different from the other. <span class="math inline">\(\Delta_t = 0.25\)</span> still gives greater performance with decent error.</p>
<p>This error could cumulate. We will explore this by simulating along the Rt changes and updating the initial conditions as we go for the ODE and <span class="math inline">\(\Delta_t = 0.25\)</span>. This is not a perfect representation of the error within the fitting process, since it will be fitted each time.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulate_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">params</span>, <span class="va">fit</span>, <span class="va">dt</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">update_model_pars</span><span class="op">(</span><span class="va">model</span>, <span class="va">params</span><span class="op">)</span></span>
<span>  <span class="co">#initial run</span></span>
<span>  <span class="va">dt_multi</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">dt</span></span>
<span>  <span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">fit</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tt_R0</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">dt_multi</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span>  <span class="va">initial_condition</span> <span class="op">&lt;-</span> <span class="fu">update_conditions</span><span class="op">(</span><span class="va">params</span>, <span class="va">output</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tt_R0</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tt_R0</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">fit</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tt_R0</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">dt_multi</span></span>
<span>    <span class="fu">update_model_pars</span><span class="op">(</span><span class="va">model</span>, <span class="va">initial_condition</span><span class="op">)</span></span>
<span>    <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>      <span class="va">output</span>,</span>
<span>      <span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">initial_condition</span> <span class="op">&lt;-</span> <span class="fu">update_conditions</span><span class="op">(</span><span class="va">initial_condition</span>, <span class="va">output</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">output</span></span>
<span><span class="op">}</span></span>
<span><span class="va">odin_params</span><span class="op">$</span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ode_run</span> <span class="op">&lt;-</span> <span class="fu">simulate_model</span><span class="op">(</span><span class="va">ode_model</span>, <span class="va">odin_params</span>, <span class="va">fit</span>, dt <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ode_time</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.25</span></span>
<span><span class="va">odin_params</span><span class="op">$</span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">dt</span></span>
<span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">diff_run</span> <span class="op">&lt;-</span> <span class="fu">simulate_model</span><span class="op">(</span><span class="va">diff_model</span>, <span class="va">odin_params</span>, <span class="va">fit</span>, dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></span>
<span><span class="va">diff_time</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">start</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tibble</span><span class="op">(</span></span>
<span>  t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ode_run</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>  ode <span class="op">=</span> <span class="fu">extract_var</span><span class="op">(</span><span class="va">ode_run</span>, <span class="va">var_of_interest</span>, <span class="va">ode_index</span><span class="op">)</span>,</span>
<span>  diff <span class="op">=</span> <span class="fu">extract_var</span><span class="op">(</span><span class="va">diff_run</span>, <span class="va">var_of_interest</span>, <span class="va">diff_index</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">ode</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">diff</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/theme_pubr.html" class="external-link">theme_pubclean</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>, y <span class="op">=</span> <span class="va">var_of_interest</span>, title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"ODE: "</span>, <span class="va">ode_time</span>, <span class="st">" seconds | Difference: "</span>, <span class="va">diff_time</span>, <span class="st">" seconds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="difference_model_files/figure-html/long-term%20error-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Unfortunately the error becomes quite large and the cumulative gain in performance is minor. We won’t use this for the main reports on these grounds, especially considering that we’d need to rerun the model to get the ODE solution at the end. However, the code structure will be left in place in-case we ever move ahead with a difference model or where the ODE fails often (the difference model should never fail).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Gregory Barnsley.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
