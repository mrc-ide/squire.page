<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="squire.page">
<title>New Fitting Method: Rt Optimisation • squire.page</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="New Fitting Method: Rt Optimisation">
<meta property="og:description" content="squire.page">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">squire.page</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/booster_pathway.html">Nimue rewrite: Booster Pathway</a>
    <a class="dropdown-item" href="../articles/rt_optimise.html">New Fitting Method: Rt Optimisation</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="rt_optimise_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>New Fitting Method: Rt Optimisation</h1>
            
      
      
      <div class="d-none name"><code>rt_optimise.Rmd</code></div>
    </div>

    
    
<p>This vignette describes the new fitting method where we optimise the <span class="math inline">\(R_t\)</span> values for a set of given parameters.</p>
<div class="section level2">
<h2 id="method-outline">Method Outline<a class="anchor" aria-label="anchor" href="#method-outline"></a>
</h2>
<div class="section level3">
<h3 id="descriptive">Descriptive<a class="anchor" aria-label="anchor" href="#descriptive"></a>
</h3>
<p>Inputs are assumed to be a set of distributions for the non <span class="math inline">\(R_t\)</span> parameters and a set of deaths that occur over set time periods, so <span class="math inline">\(D_i\)</span> deaths occur over the time period <span class="math inline">\([t_{f,i}, t_{s,i}]\)</span> for each <span class="math inline">\(i \in 1\)</span> to <span class="math inline">\(T_D\)</span>. We assume that the epidemic begins at time 0. We define our parameters to vary in the fitting process as <span class="math inline">\(\boldsymbol{R} = \{R_t;\ t\in 0\mathrm{\ to\ }T_R\}\)</span>. Each <span class="math inline">\(R_t\)</span> to comes into effect at time <span class="math inline">\(t_{R_t}\)</span>, by default this every 14 days with <span class="math inline">\(T_R = T_D - \max{\boldsymbol{\lambda}}\)</span>.</p>
<ol style="list-style-type: decimal">
<li>Generate <span class="math inline">\(N\)</span> samples from our assumed distributions on our non <span class="math inline">\(R_t\)</span> parameters. This will be discussed more in the section on <em>Parameter Uncertainty</em>.</li>
<li>Determine which deaths will be used to fit each <span class="math inline">\(R_t\)</span>. Using the structure of the model we calculate the average time from infection to death (given death is the outcome). This should match the delay between the <span class="math inline">\(R_t\)</span> value changing and its effect on the modelled deaths. This value depends on the duration parameters given to the model and on the number of hospital or ICU beds available, hence we determine all 4 possible durations, <span class="math inline">\(\boldsymbol{\lambda}\)</span>. We define the relevant deaths for an <span class="math inline">\(R_t\)</span> by choosing all deaths that lie within widest possible window that our <span class="math inline">\(R_t\)</span> value could directly effect, meaning any death that has its entire time period occur within the bounds <span class="math inline">\([t_{R_t} + \min(\boldsymbol{\lambda}), t_{R_{t+1}} + \max(\boldsymbol{\lambda})]\)</span>.
<ol style="list-style-type: decimal">
<li>For <span class="math inline">\(R_0\)</span> we set the bounds to <span class="math inline">\([0, t_{R_{1}} + \max(\boldsymbol{\lambda})]\)</span>, and for <span class="math inline">\(R_{T_R}\)</span> we set the bounds to <span class="math inline">\({t_{R_{T_R}} + \min(\boldsymbol{\lambda}), t_{s,T_D}}\)</span>.</li>
<li>For simplity we will define <span class="math inline">\(\boldsymbol{i_{R_t}} = \{i;\ t_{s,i} \geq t_{R_t} + \min(\boldsymbol{\lambda})\ \&amp;\ t_{f,i} \leq \max(\boldsymbol{\lambda})\}\)</span>, which is the indexes of all deaths that occur within <span class="math inline">\(R_t\)</span>’s fitting period</li>
</ol>
</li>
<li>For each distinct sample from the parameter distributions:
<ol style="list-style-type: decimal">
<li>Begin the estimation procedure by estimating <span class="math inline">\(R_0\)</span> and <span class="math inline">\(I_0\)</span>, the initial number of infections. <span class="math inline">\(I_0\)</span> is uniformly spread across the unvaccinated working age population.</li>
<li>When optimising <span class="math inline">\(R_t\)</span> we set upper and lower bounds on the values it can take, which will be the hyper parameters <span class="math inline">\(\alpha, \beta\)</span> with <span class="math inline">\(\alpha &gt; \beta\)</span> and <span class="math inline">\(\alpha = 10, \beta = 0.5\)</span> by default. To optimise <span class="math inline">\(I_0\)</span> we split a given range of numbers into <span class="math inline">\(N_p\)</span> values, which we’ll call <span class="math inline">\(P_{I_0}\)</span>.</li>
<li>To find our optimal values for <span class="math inline">\(R_0\)</span> and <span class="math inline">\(I_0\)</span> we optimise the log-likelihoods for each element of <span class="math inline">\(P_{I_0}\)</span> in terms of <span class="math inline">\(R_t\)</span> using the <em>Brent</em> optmisation method. The likelihood uses the negative binomial distribution with a mean equal to the modelled deaths and <span class="math inline">\(k\)</span> a user defined dispersion parameter on <span class="math inline">\(D_i\)</span>, the deaths that fall within <span class="math inline">\(R_0\)</span> fitting window as per <em>step 2</em>. We then take the <span class="math inline">\(I_0\)</span> and <span class="math inline">\(R_t\)</span> which the highest optimised likelihood as our values for <span class="math inline">\(R_0\)</span> and <span class="math inline">\(I_0\)</span>.</li>
<li>Using <span class="math inline">\(R_0\)</span> and <span class="math inline">\(I_0\)</span> we calculate the state of the models compartments at time <span class="math inline">\(t_{R_1}\)</span>, which we will call <span class="math inline">\(\boldsymbol{I_{R_1}}\)</span>.</li>
<li>For each <span class="math inline">\(R_t \in \boldsymbol{R}/R_0\)</span>:
<ol style="list-style-type: decimal">
<li>Choose <span class="math inline">\(R_t\)</span> by optimising the log-likelihood over all <span class="math inline">\(D_i\)</span> such that <span class="math inline">\(i \in i_{R_t}\)</span>
</li>
<li>With <span class="math inline">\(R_t\)</span> and <span class="math inline">\(\boldsymbol{I_{R_t}}\)</span> calculate <span class="math inline">\(\boldsymbol{I_{R_{t+1}}}\)</span> which occurs at time <span class="math inline">\(t_{R_t + 1}\)</span>.</li>
</ol>
</li>
</ol>
</li>
<li>Should end up with a set <span class="math inline">\(\boldsymbol{R}\)</span> for each sample such that modelled deaths are similar to the observed deaths.</li>
</ol>
</div>
<div class="section level3">
<h3 id="mathematical">Mathematical<a class="anchor" aria-label="anchor" href="#mathematical"></a>
</h3>
<p>Let <span class="math inline">\(\boldsymbol{p}\)</span> be a set of non-<span class="math inline">\(R_t\)</span> model parameters. Then let <span class="math inline">\(m_{I}(\boldsymbol{p}, \boldsymbol{I_{R_{t}}}, R_t, t)\)</span> be a function that returns the model state at time <span class="math inline">\(t\)</span>, given the state of the model when <span class="math inline">\(R_{t+1}\)</span> comes into effect, and <span class="math inline">\(m_{d}(\boldsymbol{p}, \boldsymbol{I_{R_t}}, R_t, t_s, t_f)\)</span> be a function that produces the number of deaths in the model occuring over time period <span class="math inline">\([t_s, t_f]\)</span>.</p>
<p>For each <span class="math inline">\(\boldsymbol{p}\)</span>:</p>
<ol style="list-style-type: decimal">
<li>
<span class="math display">\[
\{R_0, I_0\} = \mathrm{argmax}_{x,y \in [\alpha, \beta] \times \boldsymbol{P_{I_0}}}\left(
  \prod_{i \in \boldsymbol{i_{R_0}}}\frac{\Gamma(D_i + n_i)}{\Gamma(n_i)D_i!}(1-p_i)^{D_i}p_i^{n_i}
\right),
\]</span> where: <span class="math display">\[
p_i = \frac{k}{k + \mu_i},\ n_i = \frac{p_i \times \mu_i}{1-p_i} ,\ \ \mu_i =  m_d(\boldsymbol{p}, y, x, t_{s,i}, t_{f,i}).
\]</span>
</li>
<li>
<span class="math inline">\(\boldsymbol{I_{R_1}} = m_I(\boldsymbol{p}, I_0, R_0, t_{R_1})\)</span>, note that we treat <span class="math inline">\(I_0\)</span> and <span class="math inline">\(\boldsymbol{I_{R_0}}\)</span> interchangeably here.</li>
<li>For each element of <span class="math inline">\(\{t; t&gt;0\ \&amp;\ R_t \in [\alpha, \beta]\}\)</span>
<ol style="list-style-type: decimal">
<li>
<span class="math display">\[
 R_t = \mathrm{argmax}_{x \in \boldsymbol{P_{R_t}}}\left(
 \prod_{i \in \boldsymbol{i_{R_t}}}\frac{\Gamma(D_i + n_i)}{\Gamma(n_i)D_i!}(1-p_i)^{D_i}p_i^{n_i} \right)
 \]</span> where: <span class="math display">\[
 p_i = \frac{k}{k + \mu_i},\ \ n_i = \frac{p_i \times \mu_i}{1-p_i},\ \ \mu_i =  m_d(\boldsymbol{p}, \boldsymbol{I_{R_t}}, x, t_{s,i}, t_{f,i}).
 \]</span>
</li>
<li><span class="math inline">\(\boldsymbol{I_{R_{t+1}}} = m_I(\boldsymbol{p}, \boldsymbol{I_{R_{t}}}, R_t, t_{R_{t+1}})\)</span></li>
</ol>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="diagram">Diagram<a class="anchor" aria-label="anchor" href="#diagram"></a>
</h3>
<p><img src="rt_optimise_example_annotated.png" width="600px" style="display: block; margin: auto;"></p>
<p>In this diagram, the black lines represent the estimate excess mortality data and the coloured lines are the deaths produced by the chosen for each <span class="math inline">\(R_t\)</span>.</p>
</div>
</div>
<div class="section level2">
<h2 id="parameter-uncertainty">Parameter Uncertainty<a class="anchor" aria-label="anchor" href="#parameter-uncertainty"></a>
</h2>
<p>It is up to the user to setup the distributions on their parameters or just pass the function and set of parameters they like.</p>
<p>In the <em>lmic_reports</em> these are drawn from distributions representative of the epidemic, please see the <a href="https://mrc-ide.github.io/global-lmic-reports/parameters.html" class="external-link">methods page</a>.</p>
</div>
<div class="section level2">
<h2 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h2>
<p>It is necessary to bound <span class="math inline">\(R_t\)</span> above and below certain thresholds to avoid dramatically high or low changes. So far all fits seem to work well with <span class="math inline">\(R_t\)</span> ranges around <span class="math inline">\(0.5\)</span> or <span class="math inline">\(0.9\)</span> to <span class="math inline">\(10\)</span>, though it is possible for there be a curve that cannot be matched with this algorithm on simple bounds.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Gregory Barnsley.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
